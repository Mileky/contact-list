<?xml version="1.0" encoding="utf-8" ?>
<container xmlns="http://symfony.com/schema/dic/services"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://symfony.com/schema/dic/services http://symfony.com/schema/dic/services/services-1.0.xsd"
>

    <imports>
        <import resource="regExp.handlers.xml"/>
        <import resource="request.handlers.xml"/>
        <import resource="app.config.xml"/>
    </imports>

    <parameters>
        <parameter key="controllerNs">DD\ContactList\Controller</parameter>
    </parameters>

    <services>

        <defaults autowire="true" public="false">
            <bind key="string $pathToAddress" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToAddress()
            </bind>
            <bind key="string $pathToRecipients" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToRecipients()
            </bind>
            <bind key="string $pathToCustomers" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToCustomers()
            </bind>
            <bind key="string $pathToKinsfolk" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToKinsfolk()
            </bind>
            <bind key="string $pathToColleagues" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToColleagues()
            </bind>
            <bind key="string $pathToContactList" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToContactList()
            </bind>
            <bind key="string $pathToUsers" type="expression">
                service('DD\\ContactList\\Config\\AppConfig').getPathToUsers()
            </bind>

            <bind key="string $controllerNs">%controllerNs%</bind>
        </defaults>


        <prototype namespace="DD\ContactList\" resource="./../../src"/>
        <prototype namespace="DD\ContactList\Infrastructure\"
                   resource="./../../vendor/dd/framework-for-contact-list/src"/>

        <instanceof id="DD\ContactList\Infrastructure\Controller\ControllerInterface" public="true"/>
        <instanceof id="DD\ContactList\Infrastructure\Router\RouterInterface" public="true"/>
        <instanceof id="DD\ContactList\Infrastructure\Console\CommandInterface" public="true"/>


        <service id="DD\ContactList\Config\AppConfig" public="true">
            <factory class="DD\ContactList\Config\AppConfig" method="createFromArray"/>
            <argument key="$config">%app.config%</argument>
        </service>


        <service id="DD\ContactList\Infrastructure\Logger\LoggerInterface"
                 public="true"
                 class="DD\ContactList\Infrastructure\Logger\Logger"/>

        <service id="DD\ContactList\Infrastructure\Logger\AdapterInterface" public="false"
                 class="DD\ContactList\Infrastructure\Logger\Adapter\FileAdapter">
            <argument key="$pathToFile" type="service">
                <service>
                    <factory service="DD\ContactList\Config\AppConfig" method="getPathToLogFile"/>
                </service>
            </argument>
        </service>


        <service id="DD\ContactList\Entity\AddressRepositoryInterface" public="false"
                 class="DD\ContactList\Repository\AddressJsonFileRepository"/>


        <service id="DD\ContactList\Entity\ContactRepositoryInterface" public="false"
                 class="DD\ContactList\Repository\ContactJsonFileRepository"/>

        <service id="DD\ContactList\Entity\ContactListRepositoryInterface" public="false"
                 class="DD\ContactList\Repository\ContactListRepository"/>

        <service id="DD\ContactList\Infrastructure\DataLoader\DataLoaderInterface"
                 class="DD\ContactList\Infrastructure\DataLoader\JsonDataLoader"/>

        <service id="DD\ContactList\Infrastructure\ViewTemplate\ViewTemplateInterface"
                 class="DD\ContactList\Infrastructure\ViewTemplate\PhtmlTemplate"/>

        <service id="DD\ContactList\Infrastructure\Auth\HttpAuthProvider" public="false">
            <argument key="$loginUri" type="service">
                <service>
                    <factory class="DD\ContactList\Infrastructure\Uri\Uri" method="createFromString"/>
                    <argument key="$uri" type="expression">service('DD\\ContactList\\Config\\AppConfig').getLoginUri()
                    </argument>
                </service>
            </argument>
        </service>

        <service id="DD\ContactList\Infrastructure\Auth\UserDataStorageInterface"
                 class="DD\ContactList\Repository\UserJsonFileRepository"/>

        <service id="DD\ContactList\Infrastructure\Session\SessionInterface" public="false">
            <factory class="DD\ContactList\Infrastructure\Session\SessionNative" method="create"/>
        </service>


        <service id="DD\ContactList\Infrastructure\Console\Output\OutputInterface" public="true"
                 class="DD\ContactList\Infrastructure\Console\Output\EchoOutput"/>

        <service id="DD\ContactList\Infrastructure\View\RenderInterface" public="true"
                 class="DD\ContactList\Infrastructure\View\DefaultRender"/>

        <service id="DD\ContactList\Infrastructure\Router\ControllerFactory">
            <argument key="$diContainer" type="service" id="service_container"/>
        </service>

        <service id="DD\ContactList\Infrastructure\Router\RouterInterface"
                 class="DD\ContactList\Infrastructure\Router\ChainRouters">
            <argument type="service" id="DD\ContactList\Infrastructure\Router\RegExpRouter"/>
            <argument type="service" id="DD\ContactList\Infrastructure\Router\DefaultRouter"/>
            <argument type="service" id="DD\ContactList\Infrastructure\Router\UniversalRouter"/>
        </service>

        <service id="DD\ContactList\Infrastructure\Router\RegExpRouter">
            <argument key="$handlers">%regExp.handlers%</argument>
        </service>

        <service id="DD\ContactList\Infrastructure\Router\DefaultRouter">
            <argument key="$handlers">%request.handlers%</argument>
        </service>

    </services>

</container>